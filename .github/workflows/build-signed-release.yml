name: Build Signed Release APK and Create Release

on:
  push:
    branches:
      - add-nfclab
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  packages: write

env:
  REL_KEYSTORE: release-keystore.jks
  ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure Gradle wrapper exists (fail early if missing)
        run: |
          if [ ! -f "./gradlew" ]; then
            echo "ERROR: gradlew not found in repo. Please add the Gradle wrapper to the repository before running CI."
            echo "Locally run: ./gradlew wrapper --gradle-version 8.4 (or appropriate version)"
            exit 1
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ${{ runner.temp }}/.gradle
          key: gradle-cache-${{ runner.os }}-v1-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-cache-${{ runner.os }}-v1-

      - name: Install Android SDK command-line tools and Build Tools / Platform
        run: |
          set -euo pipefail
          SDK_ROOT="${ANDROID_SDK_ROOT}"
          mkdir -p "${SDK_ROOT}"
          cd /tmp
          CMDLINE_ZIP=commandlinetools-linux-9477386_latest.zip
          if [ ! -d "${SDK_ROOT}/cmdline-tools/latest" ]; then
            curl -fsSL "https://dl.google.com/android/repository/${CMDLINE_ZIP}" -o cmdline-tools.zip
            unzip -q cmdline-tools.zip -d "${SDK_ROOT}/cmdline-tools"
            mv "${SDK_ROOT}/cmdline-tools/cmdline-tools" "${SDK_ROOT}/cmdline-tools/latest"
          fi
          export PATH="${SDK_ROOT}/cmdline-tools/latest/bin:${PATH}"
          yes | sdkmanager --sdk_root="${SDK_ROOT}" --licenses >/dev/null || true
          sdkmanager --sdk_root="${SDK_ROOT}" "platform-tools" "platforms;android-36" "build-tools;36.0.0"
          echo "ANDROID_SDK_ROOT=${SDK_ROOT}" >> $GITHUB_ENV
          echo "${SDK_ROOT}/platform-tools" >> $GITHUB_PATH
          echo "${SDK_ROOT}/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "${SDK_ROOT}/build-tools/36.0.0" >> $GITHUB_PATH

      - name: Ensure gradlew is executable
        run: chmod +x ./gradlew

      - name: Decode keystore from secret to file
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        run: |
          echo "Decoding KEYSTORE_BASE64 to ${REL_KEYSTORE}"
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > "${REL_KEYSTORE}"
          ls -l "${REL_KEYSTORE}"
        shell: bash

      - name: Build release APK (signed using environment-provided signing config)
        env:
          KEYSTORE_PATH: ${{ github.workspace }}/${{ env.REL_KEYSTORE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          echo "Starting Gradle assembleRelease..."
          ./gradlew :app:clean :app:assembleRelease --no-daemon --stacktrace

      - name: Find generated release APK
        id: find_apk
        run: |
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            echo "APK found at $APK_PATH"
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Release APK not found at expected path: $APK_PATH"
            ls -la app/build/outputs || true
            exit 1
          fi

      - name: Verify APK signature (apksigner)
        run: |
          APK="${{ steps.find_apk.outputs.apk_path }}"
          if command -v apksigner >/dev/null 2>&1; then
            apksigner verify --print-certs "$APK" || true
          else
            jarsigner -verify -verbose -certs "$APK" || true
          fi

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: signed-release-${{ github.run_number }}-${{ github.sha }}
          release_name: "NfcLab Signed Release ${{ github.run_number }}"
          body: |
            Signed release APK built by GitHub Actions.
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            NOTE: This APK was signed using keystore provided via repository secrets.
          draft: false
          prerelease: false

      - name: Upload signed APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_apk.outputs.apk_path }}
          asset_name: NfcLab-app-release.apk
          asset_content_type: application/vnd.android.package-archive

      - name: (Optional) Publish to Google Play - Internal track
        if: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON != '' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.labtools.nfc
          releaseFiles: ${{ steps.find_apk.outputs.apk_path }}
          track: internal
          mappingFile: ""

      - name: Final message
        run: |
          echo "Signed APK uploaded to GitHub Release."
          echo "Release Tag: signed-release-${{ github.run_number }}-${{ github.sha }}"